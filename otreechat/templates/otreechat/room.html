<div class='otreechat' id='otreechat'>
    <div class='messages'></div>
    <input>
    <button type="button">Send</button>
</div>


<style>
    #otreechat {
        border: 1px solid #ccc;
        padding: 5px;
        margin: 30px 0 0 0;
    }
    #otreechat .messages {
        height: 200px;
        overflow: auto;
        background: #eee;
        margin: 2px 0 5px 0;
    }
    #otreechat .nickname {
        display: inline-block;
        color: #C07A36;
        width: 100px;
        font-weight: bold;
    }
</style>


<script>
    $(function () {

        // simple helper function to escape HTML
        var entityMap = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
          '/': '&#x2F;',
          '`': '&#x60;',
          '=': '&#x3D;'
        };

        function escapeHtml (string) {
          return String(string).replace(/[&<>"'`=\/]/g, function (s) {
            return entityMap[s];
          });
        }

        var room = "{{ room }}";
        var participant_code = "{{ participant.code }}";
        var nickname = "{{ nickname|escapejs }}"; // FIXME: escape JS?
        var $message_input = $('#otreechat input');

        var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
        var ws_path = ws_scheme + '://' + window.location.host + "/otreechat/{{ room }}/";
        console.log("Connecting to " + ws_path);
        var socket = new ReconnectingWebSocket(ws_path);
        var msgdiv = $("#otreechat .messages");

        // Handle incoming messages
        socket.onmessage = function (message) {
            // Decode the JSON
            console.log("Got websocket message ");
            var data = JSON.parse(message.data);
            // Handle errors
            if (data.error) {
                alert(data.error);
                return;
            }

            var nickname = data.nickname;

            {% comment %}
            Show my own nickname, so I know how it will look to
            others who read it.
            {% endcomment %}
            if (data.participant_code == participant_code) {
                nickname += ' (Me)';
            }

            var ok_msg = "<div class='message'>" +
                        "<span class='nickname'>" + escapeHtml(nickname) + "</span>" +
                        "<span class='body'>" + escapeHtml(data.message) + "</span>" +
                        "</div>";
            msgdiv.append(ok_msg);
            msgdiv.scrollTop(msgdiv.prop("scrollHeight"));
        };

        socket.onopen = function () {
            console.log("Connected to chat socket");
        };
        socket.onclose = function () {
            console.log("Disconnected from chat socket");
        };

        function send_message() {
            var data = {
                'message': $message_input.val(),
                'participant_code': participant_code,
                'room': room,
                'nickname': nickname
            };

            socket.send(JSON.stringify(data));
            $message_input.val('');
        }

        $('#otreechat button').click(function(e) {
            send_message();
        });

        // pressing "enter" in the message box should submit a message,
        // NOT the page's form
        $message_input.on('keypress', function (e) {
            if (e.which == 13) {
                e.preventDefault();
                send_message();
            }
});


    });
</script>
